# SmartSpace - Аренда
Контракт аренды Space токена SpaceRentalBasic.

Контракт не является частью инфраструктуры фондов.

* [Описание проблемы](#Описание-проблемы)

## Описание проблемы
Владельцу Space токена необходимо предоставить возможность получения дохода путем сдачи в аренду репутации Space токена.

## Цели контракта
Предоставить базовый функционал аренды репутации несколькими пользователями.

## Сценарии контракта

### Сценарий 1: Аренда для владельца земли

1. Пользователь А имеет в собственности 1 Space токен, залоговая стоимость (репутация) которого составляет 2500 GALT. Он хочет заработать путем продажи репутации этого токена. Он создает смарт-контракт SmartSpaceBasic, где в качестве параметров указывает:
    * Длину одного периода - 3 дня (72 * 60 * 60 = 259200 секунд)
    * Размер ставки за один период и 100% репутации в нем. Например, 250 GALT за 100% репутации на 1 период.
    * Кол-во будущих периодов, доступных для вступления арендаторами - 5 периодов.
Созданный контракт является не активным, все операции с ним заблокированы. Контракт ожидает поступления токена на его адрес.

2. Пользователь А переводит свой Space токен на созданный в п.1 контракт.
    * Контракт развернутый в п. 1 активируется, операции с ним становятся доступными.
    * 100% токена, находящегося на контракте, принадлежит владельцу контракта (Пользователь А). Технически, сначала репутация переводится от Пользователя А контракту, а после контракт перераспределяет всю репутацию обратно Пользователю А.

3. Любой пользователь может внести аренду за 0, 1, 2, 3, 4 и 5 периоды. Пользователь B переводит на контракт 100 GALT за 0 период.
    * Сохраняется timestamp текущей транзакции для дальнейшего рассчета периодов
    * Начинается 0 период

Пользователи | A | B |
--- | --- | --- |
Репутация до | 2500 | 0 |
Репутация после | 1500 | 1000 |

4. Период 0. Пользователь B вносит аренду за 3й период в размере 150 GALT.
    * Распределение репутации между участниками не происходит.

5. Период 0. Пользователь А выводит все платежи в размере 250 (100 + 150) GALT с контракта аренды.
    * Распределение репутации между участниками не происходит.

6. Начинается период 1. Пользователь А отзывает репутацию участников периода 0 явным выполнением транзакции отзыва. На период 1 заявок на аренду нет.

Пользователи | A | B |
--- | --- | --- |
Репутация до | 1500 | 1000 |
Репутация после | 2500 | 0 |

7. Начинается период 2. Отзывать репутацию нет необходимости.
    * Распределение репутации между участниками не происходит.

8. Период 2. Пользователь C вносит аренду в размере 200 GALT за 2й период.

Пользователи | A | B | С |
--- | --- | --- | --- |
Репутация до | 2500 | 0 | 0 |
Репутация после | 500 | 0 | 2000 |

9. Период 2. Пользователь D вносит аренду в размере 50 GALT за 2й период.

Пользователи | A | B | С | D |
--- | --- | --- | --- | --- |
Репутация до | 500 | 0 | 2000 | 0 |
Репутация после | 0 | 0 | 2000 | 500 |

10. Начинается период 3. Пользователь A забывает отозвать репутацию у участников 2-ого периода. Распределение репутации остается слеующим:

Пользователи | A | B | С | D |
--- | --- | --- | --- | --- |
Репутация | 0 | 0 | 2000 | 500 |

Пользователь B, который внес свой залог за 3-й период, по факту остается без оплаченной репутации.

11. Начинается период 4. Пользователь А отзывает репутацию за период 2. Отзывать репутацию за период 3 уже не требуется.
12. Пользователь А блокирует вступление новых пользователей и продление аренды текущими.
13. Пользователь А выводит платежи, поступившие в пунктах 8 и 9 (250 GALT в сумме) на свой адрес.
14. Пользователь А выводит GALT токен с контракта на свой адрес. Технически, репутация сначала отзывается у пользователя А на адрес контракта, а потом, вместе с Space токеном, переводится ему обратно. Контракт блокируется для операций с ним.
15. Пользователь А оставляет контракт развернутым, но т.к. он заблокирован, он бесполезен.

## Спецификация
### Создание и настройка контракта

* При деплое (создании) контракта аренды владелец контракта указывает следующие данные (в конструкторе):
  * Величину одного периода в секундах. Например, 30 * 24 * 60 * 60 секунд за 1 период.
  * Размер ставки за один период и 100% репутации в нем. Например, 250 GALT за 100% репутации на 1 период.
  * Кол-во будущих периодов, доступных для вступления арендаторами. Например, 5 - это значит, пользователь может уже внести арендную плату на 5 периодов (по 30 дней каждый) вперед, не включая текущий. На каждый период отдельная транзакция.
* По умолчанию минимальный депозит за 1 период составляет 1 GALT. Может быть изменен отдельной транзакцией. В любом случае не может быть менее 1 GALT.
* Перечислить токен на контракт аренды может только создатель контракта, при попытке перевода с других адресов, транзакция будет отклоняться.
* При попытке перечислить второй токен на контракт, транзакция будет отклоняться.
* После перевода токена вся репутация переводится владельцу контракта. Об этом контракт аренды явно уведомляет контракт репутации.

### Вступление арендаторов

* Внести аренду можно на текущий период и кол-во периодов вперед, указанное при создании контракта. Например, если там указано 5, и текущий период 7, внести аренду можно за 7, 8, 9, 10, 11, 12 периоды.

### Вывод GALT собственником контракта
* GALT, переведенные на контракт в качестве платежа за аренду, собственник контракта может сразу же вывести на свой адрес.

### Изменение
#### Владелец может:

* Закрыть контракт и вывести space токен, если ни на данный момент нет ни одного активного арендатора.
* Приостановить вступление новых арендаторов. 
* Приостановить возможность продления для текущих арендаторов.
* Изменить ставку ТОЛЬКО при отсутствии активных арендаторов.
* Изменить минимальную ставку платежа за 1 период.

#### Владелец ОБЯЗАН!!!:

* В начале каждого периода отзывать репутацию пользователей из предыдущего периода отдельной транзакцией.

#### Арендатор может:

* Продлить аренду, внеся оплату за будущие периоды, если в них еще есть место.
* Увеличивать уже оплаченную долю в текущем и последующих периодах, если есть еще место.

#### Арендатор НЕ может:
* Отозвать уже оплаченную аренду за любой период.
* Изменить длину периода

### Репутация

Изменения долей аренды отражаются в следующих контрактах:

- локальная репутация (изменяется репутация адреса)
- глоальная репутация (изменяется репутация адреса)
- голосование (пока нет понимания, как это может работать в рамках solidity)

## Математика
### Рассчет репутации

R = floor(Tr * Ud / Rp)
  * R - арендуемая репутация пользователя в данные период (в GALT)
  * Tr - репутация токена (в GALT)
  * Ud - арендный депозит пользователя за данный период (в GALT)
  * Rp - ставка за 100% аренды на 1 период

Например:
* Space токен имеет репутацию 1500 GALT
* Ставка за 100% равна 250 GALT
* Уплаченная пользователем аренда 60 GALT

Это означает, что:
* R = floor(1500 * 63,53 / 250)
* R = floor(1500 * 0,25412)
* R = floor(381,18)
* R = 381

Пользователь получает 381 GALT репутации на арендуемый период.

### Рассчет текущего периода

Cp = (Ct - It) / L
  * Cp - текущий период
  * Ct - текущий timestamp
  * It - timestmap первого внесения денежных средств первым арендатором
  * L - длина периода в секундах

## Технические аспекты
### TypeScript
* В качестве текущего времени используется +Date.now()

### Solidity
* В качестве текущего времени используется timestamp последнего блока

## Проблемы
* Может лучше сдлеть минимально-делимый перод - 1 час? Слишком большие числа хранить в секундах.
* Существует вероятность того, что в начале нового периода пользователь не отзовет репутацию у предыдущих владельцев. Например он забудет это сделать. И пока он этого не сделает, репутация токена будет числится за участниками предыдущего периода аренды. Если же владелец вовсе этого не сделает - у нас получится период, в котором репутация не была распределена корректно.
