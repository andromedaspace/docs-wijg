# Контракт Аукцион земли - Требования

* Epic issue https://github.com/andromedaspace/WIJG/issues/363
* UI Mindmap https://mm.tt/1116945428?t=Ko5NjQKJPi

## Описание проблемы
Необходимо обеспечить первичную продажу по максимально честной цене и выпуск SPACE токенов с условием того, что на аукцион переданы SPACE токены Территории, которые определяют допустимую область земли, на которой можно через аукцион приобрести дочерние SPACE токены. Таким образом нужно чтобы аукцион позволял сделать ставку на ещё не выпущенный SPACE токен, но в разрешенной Территории, чтобы после всех проверок был создан новый токен SPACE и запущен на него аукцион.

## Цели контракта
- SPACE токены нужно продавать на аукционе по максимально честной цене избежав недостатки традиционного аукциона, когда опоненты перебивают ставки по минимальному увеличению цены.
- Необходимо реализовать аукцион земли базируясь на абстрактном классе [Аукциона Викри](Аукцион-Викри.md) со всеми его требованиями.
- Дать возможность пользователям самим выбирать какой они хотят купить геохеш из доступной области на аукционе.
- Избежать ситуации когда пользователи покупают родительские геохеши с наибольшей площадью участков и на этом аукцион первичной продажи заканчивается.

## Входные данные

|Параметр|Контракт|
|-------|--------|
|id заявки на ввод Территории|Контракт SPACEAuctionRegistry|
|Максимальный размер участка на аукционе по id заявки на ввод Территории|Контракт CreateTerritory|
|Минимальный размер участка на аукционе id заявки на ввод Территории|Контракт CreateTerritory|
|Минимальная ставка для минимального размера участка в GALT |Контракт CreateTerritory|

## Основные требования:
- Аукцион должен выпускать SPACE токены после проверки, что токен можно купить и после первой ставки, т.е. после создания лота на аукционе.
- Минимальная цена на геохеш должна определяться величиной области участка геохеша: чем больше область - тем больше цена.
- На первичном аукционе должны быть только геохеши тех размерностей, который были указаны в Заявке на ввод Территории.
- При вторичной продаже SPACE токена - необходимо обеспечить стандартную работу аукциона без возможности выпуска нового дочернего токена.
- Минимальная цена лота при повторном выставлении токена будет такой же, как при первичном.
- Для повторных лотов правила по минимальному и максимальному размеру участка не действуют.
- Победитель лота аукциона получает во владение SPACE токен.

## Сценарий контракта
### Сценарий 1: Первичная продажа SPACE токена
1. При запуске контракта из контракта GaltGenesis контракт SpaceAuction запрашивает по id заявки на ввод Территории следующие параметры из контракта CreateTerritory: Максимальный размер участка на аукционе по id заявки на ввод Территории, Минимальный размер участка на аукционе id заявки на ввод Территории, Минимальная ставка для минимального размера участка в GALT. Контракт записывает эти параметры себе для дальнейшего использования.
2. Пользователь отправляет Заявку на лот. В заявке на лот он указывает: Геохеш участка, который хочет купить, открытую ставку, закрытую ставку.
3. Контракт SpaceAuction делает проверку допустимости лота:
- проверяет, что 

1. Пользователь 2 находит информацию о том, какие родительские хеши выставлены на аукционе
2. Пользователь 2 выбирает какой из дочерних геохешей он хочет приобрести
3. Пользователь 2 проверяет что, тот геохеш, который он хочет приобрести - доступен для продажи:
- один из его родителей находится на аукционе(если пользователь хочет купить sezu0123 - то sezu012 или sezu01 или sezu0 должно находится на аукционе);
- он и его родители ещё не проданы(если пользователь хочет купить sezu0123 - то sezu012 или sezu01 или sezu0 не должны быть проданы);
4. Пользователь 2 получает информацию о минимальной цене на этот геохеш: 100 GALT
5. Пользователь 2 делает ставку на этот геохеш, которая должен быть больше его минимальной цены: 600 GALT публичной ставки и 300 GALT секретной ставки
6. Пользователь 1 делает ставку на тот-же геохеш: 400 GALT публичной ставки и 200 GALT секретной ставки
![image](https://user-images.githubusercontent.com/4842007/41902701-6114264a-7934-11e8-83f0-30d647966d43.png)
7. После окончания приода действия аукциона на этот лот - пользователь вызывает функцию finishAuction, получая обратно разницу между второй секретной ставкой(200 GALT) в топе и своей публичной ставкой: 400 GALT
8. finishAuction создает SPACE токен, который получает залог 200 GALT

### Сценарий 2: Продажа после отказа владельцем от SPACE токена. Единственный покупатель на аукционе
1. Пользователь отказывается от SPACE токена с залоченными 500 GALT за ним
2. SPACE токен оказывается на аукционе с минимальной ценой 500 GALT
3. На данный лот ставит единственный пользователь публичную ставку 700 GALT и секретную ставку 600 GALT
4. Больше никто не ставит на данный лот
5. Спустя какое-то время аукцион заканчивается и победитель получает разницу между 700 и 500: 200 GALT
6. Также победитель получает во владение данный SPACE токен

### Сценарий 3: Продажа после отказа владельцем от SPACE токена. Ставка равна минимальной цене
1. Пользователь отказывается от SPACE токена с залоченными 400 GALT за ним
2. SPACE токен оказывается на аукционе с минимальной ценой 400 GALT
3. На данный лот ставит единственный пользователь публичную ставку 400 GALT и секретную ставку 400 GALT
4. Больше никто не ставит на данный лот
5. Так как суммы публичной ставки и минимальной цены равны - пользователь не получает разницу между ценами, так как она равна 0
6. Победитель получает во владение данный SPACE токен

## Спецификация контракта
- Название класса: SpaceAuction
- Наследуется от абстрактного класса [Аукциона Викри](Аукцион-Викри.md)
- Добавлена связь с токеном SPACE для проверки наличия у продавца SPACE токена и передачи SPACE токена при успешной продаже
- Добавляется право на создание SPACE токенов, геохеши которых являются дочерними к тем, чтобы были выложены на аукцион

## Неоднозначные вопросы и ответы на них
### Как сделать так, чтобы один адрес не мог выиграть Аукцион на очень большую территорию?
Описание проблемы: Должен быть предусмотрен гибкитй механизм, который позволит распределить землю между оптимальным количеством владельцев. Не должно быть пользователей, которые смогут получить в собственность слишком большое количество земли дешево, так как это создаст дисбаланс в экономике.
#### Вариант №1
Можно ввести минимальное значение ставки для каждой разрядности Геохеша.

|Плюсы|Минусы|
|-----|-------|
|Полностью рыночное регулирование ограничения|Сложно решить заранее, какая минимальная ставки решит проблему. Можно ошибиться.|

#### Вариант №2
Ввести минимальный и максимальный размер геохеша для аукциона. Не использовать разные минимальные ставки. Любой разряд геохеша стоит одинаково.

|Плюсы|Минусы|
|-----|-------|
|Позволит сделать "Защиту от дурака" на случай ошибки с выбором ставок|Участки разного размера с разным разрядом будут на начальном этапе иметь одинаковую начальную цену. Это перекос. Можно будет в рамках разрешенного для продажи диапазона купить большой участок дешево.|

#### Вариант №3
Использовать оба варианта.

|Плюсы|Минусы|
|-----|-------|
|Позволит сделать "Защиту от дурака" на случай ошибки с выбором ставок| Не решает идеально проблему. Начальная ставка на большой участок пустыни будет в десятки раз выше начальной ставки на небольшой участок с низким залеганием грунтовых вод. Хотя второй реально должен стоить больше. Хотя, вероятно, это выровняет аукцион.|

### Какая минимальная ставка для какой разрядности Геохеша допустима и как ее определить?
Нужно все взвесить.
### Как обеспечить гармоничное развитие территории с точки зрения плотности проживания?
Описание проблемы: Если любой человек сможет купить землю в любом месте, то на начальном этапе мы получим большое количество землевладений, расположенных на большом удалении друг от друга. В таком случае им вместе сложно будет развиваться из-за удаленности друг от друга. Компактность проживания дает большие преимущества для экономических связей, безопасности и комфорта. Нам нужно заложить механизм, который позволит сделать так, что люди покупали землю друг с другом.
Решение:
- Заложить токены участков, которые не будут никому принадлежать и станут "начальными точками роста". Начальные точки роста можно задать исходя из ресурсов и привлекательности конкретной области;
- Участок землю можно будет купить на аукционе только в том случае, если он граничит с начальной точкой роста или соседний участок уже продан;
Формальное описание решения:
- Добавить проверку "соседний участок" = начальная точка роста ИЛИ "соседний участок" - продан.
### Как сделать так, чтобы не продать всю землю сразу?
Описание проблемы: Скорость продажи земли должна быть согласована со скоростью экономического развития территории и привлечением дополнительных Эфиров в Фонд. Если вся земля будет получена пользователями в результате аукционов слишком быстро и дешево, то это значительно снизит возможные темпы развития экономики территории, так как уменьшить объем привлечения новых средств в Фонд. Смысла получать GALT на Аукционе Эмиссии будет меньше, если не будет свободной земли, которую можно выиграть.
Возможные решения:
- Сделать сроки проведения аукционов динамическими. Подумать от каких параметров они могут зависеть.

## Особенности реализации на TypeScript
- На TypeScript сейчас реализована простейшая продажа отдельных участков земли, выкладываемых в рамках деплоя на аукцион.
Нет логики доступных областей, есть только выложенные участки на аукцион для их прямой продажи.
- Также при покупке земли не указывается в какой фонд будет передан залог, залог всегда передается в 0 фонд.
