# PlotClarificationManager

## Описание проблемы
Необходимо создать инструмент для уточнения геохешей для уже созданного участка путем утверждения Заявки Валидатором или Валидаторами.

## Спецификация контракат
### Статусы Заявки

* NEW - заявка только подана
* VALIDATION_REQUIRED - заявка подана заявителем на оценку
* VALIDATION - конкретный валидатор заблокировал за собой оценку заявки
* PAYMENT_REQUIRED - ожидается оплата заявки заявителем
* SUBMITTED - заявка оплачена и ожидает рассмотрения валидаторами
* APPROVED - все валидаторы одобрили заявку
* REVERTED - один из валидаторов вернул заявку на доработку
* PACKED - в заявку добавлены необходимые геохеши

![Application Status List](https://github.com/galtspace/galtproject-docs/raw/chebykin-patch-10/images/PlotClarificationManager.png?raw=true "Application Status List")

### Дополнительные флаги заявки

* TOKEN_WITHDRAWN - токен упаковки был отозван обратно заявителем
* GAS_DEPOSIT_WITHDRAWN - депозит за газ был выдан
    * либо валидатору - заявки со статусом APPROVED/PACKED
    * либо назад заявителю - заявки со статусом REVERTED/REJECTED и флагом TOKEN_WITHDRAWN 

### Статусы Роли валидатора
* INTACT - валидатор не назначен
* LOCKED - валидатор заблокировал за собой заявку и рассматривает ее
* APPROVED - валидатор одобрил заявку
* REVERTED - валидатор вернул заявку на доработку

### Интерфейсы для взаимодействия с контрактом
#### Интерфейс для владельца контракта

Владелец контракта может:

* Изменить минимальный размер комиссии в ETH
* Изменить минимальный размер комиссии в GALT
* Изменить долю комиссии, распределяемой в пользу GaltSpace в ETH (остаток распределяется в пользу валидаторов)
* Изменить долю комиссии, распределяемой в пользу GaltSpace в GALT (остаток распределяется в пользу валидаторов)
* Установить, какой из способов оплаты сейчас принимается (никакой, GALT, ETH, GALT И ETH)
* Установить адрес выплат комиссий от огранизации GaltSpace
* Остановить/Возобновить работу контракта (напр. в случае подозрения на наличие уязвимости)

##### #resetApplicationRole()
Владелец контракта может снять конкретного валидатора с роли в заявке

* Метод возможен только для
    * Заявок в статусе SUBMITTED
    * Ролей в статусе LOCKED/APPROVED

##### #claimGaltSpaceReward()
Владелец контракта забирает свою долю комиссии, оплаченную заявителем

* Метод возможен только для заявок
    * в статусах PACKED, REVERTED, REVOKED
    * флага TOKEN_WITHDRAWN == true
    * флага GAS_DEPOSIT_WITHDRAWN == true
* В зависимости от выбранной валюты, на адрес, указанный владельцем контракта, перечисляются либо ETH либо GALT

#### Интерфейс для заявителя
##### #applyForPlotClarification()

Владелец Space токена-упаковки подает заявку на уточнение границ участка.

* Указываются детали участка (кадастровый номер, полное имя и номер документа, точность апроксимации)
* Токен упаковки передается на контракт PlotClarificationManager
* Заявка сразу после создания имеет статус NEW

##### #submitApplicationForValuation()
Заявитель вызывает метод, когда вся информация заполнена и он готов отправить заявку на оценку валидатору с ролью “Добавление геохешей”.

* Метод доступен только для заявок в статусах NEW
* Статус заявки переходит в VALUATION_REQUIRED

##### #submitApplicationForReview()
Заявитель вызывает метод для подачи заявки на рассмотрение, прилагая оплату за комиссию и аванс за запись геохешей.

* Метод доступен только для заявок в статусах PAYMENT_REQUIRED
* Одновременно оплачиваются:
    * Предоплата за газ в ETH, ранее оцененная валидатором
    * Комиссия в ETH за рассмотрение заявки валидаторами
* В заявку назначаются(копируется) текущий список ролей для валидации из контракта Validators. В случае изменения списка необходимых ролей в контракте Validators, список уже назначенных ролей в заявках не меняется.
* Статус заявки переходит в SUBMITTED

##### #submitApplicationForReviewGalt()
Все то же самое, что и в #submitApplication(), только оплата комиссии за рассмотрение заявки принимается в GALT

##### #resubmitApplication()
Повторная подача заявки, возвращенной на доработку

* Метод доступен только для заявок в статусах REVERTED
* Статусы всех ролей сбрасываются в LOCKED
* Статус заявки переходит в SUBMITTED

##### #withdrawPackageToken()
Заявитель отзывает заявку с рассмотрения и забирает токен упаковки обратно.

* Метод доступен только для заявок
    * в статусах NEW, PAYMENT_REQUIRED, REVERTED, PACKED
    * Флаге TOKEN_WITHDRAWN == false
* Токен упаковки передается назад на адрес заявителя
* Устанавливается флаг TOKEN_WITHDRAWN в значение true

##### #claimApplicantGasDeposit()
Заявитель самостоятельно забирает не использованный депозит за газ

* Метод доступен только для заявок
    * в статусе REVERTED
    * Флаге TOKEN_WITHDRAWN == true
    * Флаге GAS_DEPOSIT_WITHDRAWN == false
* Депозит в ETH передается с адреса контракта на адрес заявителя
* Выставляется флаг GAS_DEPOSIT_WITHDRAWN в значение true


#### Интерфейс для валидаторов с ролью “Добавление геохешей”
Все действия, перечисленные в данном разделе, доступны только для валидатора с ролью “Добавление геохешей”.

##### #lockApplicationForValuation()
* Метод доступен только для заявок в статусе VALUATION_REQUIRED
* Роль “добавления геохешей” блокируется за откликнувшимся валидатором и переходит в статус LOCKED
* Статус заявки переходит в VALUATION

##### #valuateGasPrice()
Валидатор оценивает стоимость операции по записи новых геохешей в упаковку

* Метод доступен только для заявок в статусах VALUATION
* Указывается оценочная стоимость операций по записи новых геохешей (только в ETH)
* Статус заявки переходит в PAYMENT_REQUIRED

##### #addGeohashesToApplication()
Валидатор добавляет геохеши в упаковку

* Метод доступен только для заявок в статусах APPROVED
* Статус заявки не меняется

##### #applicationPackingCompleted()
Валидатор закончил добавление геохешей, упаковка готова

* Метод доступен только для заявок в статусах APPROVED
* Статус заявки переходит в PACKED

##### #claimValidatorGasDeposit()
Валидатор забирает депозит за газ для добавления геохешей в упаковку

* Метод доступен только для заявок
    * в статусе APPROVED и PACKED
    * флаге GAS_DEPOSIT_WITHDRAWN == false
    * Соответствующей роли валидатора
* Депозит в ETH передается с адреса контракта на адрес валидатора
* Выставляется флаг GAS_DEPOSIT_WITHDRAWN в значение true

Интерфейс для всех валидаторов

##### #lockApplicationForReview()
Валидатор с конкретной ролью блокирует за собой право на работу над заявкой

* Метод доступен только для заявок в статусе VALUATION
* Метод доступен только для ролей в статусе  INTACT
* Метод недоступен для роли “Добавление геохешей”
* Одна роль может быть занята только одним валидатором
* Заявка остается в статусе SUBMITTED
* Статус роли переоходит в LOCKED

##### #approveApplication()
Валидатор одобряет заявку в рамках своей роли.

* Метод доступен только для заявок в статусе SUBMITTED
* Метод доступен только для ролей в статусе  LOCKED
* Метод может быть вызван даже если остальные роли остаются в статусе INTACT
* Статус заявки
    * Меняется на APPROVED - если все назначенные роли одобрили заявку
    * Остается SUBMITTED - если хотя бы одна роль еще не вынесла своего решения и остается в статусе LOCKED
* Статус роли переоходит в APPROVED

##### #revertApplication()
Валидатор возвращает заявку на доработку.

* Метод доступен только для заявок в статусе SUBMITTED
* Метод доступен только для ролей в статусе  LOCKED
* Метод может быть вызван только после того, как все роли перешли в статус LOCKED (для корректного распределения вознаграждения между валидаторами)
* Валидатор должен указать причину возврата, строка с причиной хранится в блокчейне
* Статус заявки меняется на REVERTED - если хотя бы один из валидаторов решил отказать и сменил статус роли на REVERTED
* Статус роли переоходит в REVERTED

##### #claimValidatorReward()
Валидатор забирает свое вознаграждение

* Метод доступен только для заявок
    * в статусах PACKED, REVERTED
    * флага TOKEN_WITHDRAWN == true
    * флага GAS_DEPOSIT_WITHDRAWN == true
* В зависимости от типа заявки, на адрес валидатора перечисляются либо ETH либо GALT
* Проставляется флаг, что валидатор на данной роли получил вознаграждение
* Статус заявки не изменяется

## TOP10 рисков

1. Если в контракте обнаруживается уязвимость
    1. Работа контракта приостанавливается (Pausable)
    2. Уязвимость устраняется и контракт обновляется с помощью прокси
    3. Работа контракта возобновляется
2. Если нет возможности обновить контракт с помощью прокси
    1. Работа контракта приостанавливается
    2. Владелец контракта
        1. Возвращает токены упаковок назад заявителям
        2. Сжигает (burn) токены геохешей, еще не добавленные в упаковку, но находящиеся на контракте
        3. Выводит оплаченную комиссию в GALT/ETH и распределяет ее между адресами валидаторов по своему усмотрению
        4. Выводит депозиты за газ и распределяет их между заявителем/валидатором с ролью “добавление геохешей” по своему усмотрению
    3. Разворачивается новый контракт (при необходимости - с модификациями)
    4. Заявки в новый контракт НЕ переносятся, работа с ним начинается с ноля.
3. Заявитель потерял свой ключ TBD
4. Нет связи с заявителем, назначенным на роль TBD
5. Валидатор назначенный на роль в заявке потерял свой ключ TBD
6. Нет связи с валидатором, назначенным на роль TBD
7. Валидатор злонамеренно подтвердил некорректную заявку
    1. Достаточно, чтобы любой другой валидатор выставил флаг REVOKED/REVERTED
8. Валидаторы не хотят работать над заявкой TBD
10. Валидатор добавил не все геохеши в упаковку и выставил флаг, что добавление готово - TDB


## Примеры
### Сценарий №1: Уточнение геохешей участка - Не реализовано

0. Вводим тип заявки - Уточнение геохешей.

1. У пользователя в меню Мои участки в контекстном меню по операциям с участком отображается кнопка `Уточнить геохеши участка`.

2. Если пользователь нажал кнопку, то появляется меню для ввода данных по заявке аналогично созданию новой заявки: кадастровый номер, полное имя и номер документа, точность апроксимации. Пользователь нажимает Создать. Создается транзакция с вызовом метода контракта PlotManager, который создает заявку со статусом Новая и передает токен Участка контракту PlotClarificationManager.

3. Пользователь заходит в меню Мои заявки. Нажимает кнопку "Отправить заявку на оценку". Создается транзакция с вызовом метода контракта PlotClarificationManager. Статус заявки меняется на "Отправлена на оценку".

4. Валидатор, имеющий Роль = "Добавление геохешей" нажимает кнопку "Забрать заявку". Для этого статуса заявки нужен только один валидатор с этой Ролью. Статус меняется на - "Оценка стоимости".

5. Валидатор, имеющий Роль = "Добавление геохешей" нажимает кнопку "Оценить стоимость" (кнопка доступная только этой роли), строится апроксимация геохешей (строго по переменной из заявки) и происходит примерный расчет стоимости создания и добавления геохешей в Участок. Валидатор нажимает кнопку "Отправить на оплату", создается транзакция с вызовом метода, который записывает стоимость комиссии в GALT, исходя из текущего курса и расходов на газ. Статус заявки - "Ожидание оплаты".

6. Пользователь для заявок со статусом Ожидание оплаты видит кнопку Оплатить. При нажатии кнопки создается транзакция с вызовом метода. Статус заявки - "Оплачена, ожидает утверждения".

7. Остальные роли могут назначить себе заявку. Первый Валидатор, который уже назначен - остается. Статус меняется на "На утвреждении".

8. После того как все валидаторы утвердили заявку статус меняется на "Утверждена".

9. Валидатор с ролью "Добавление геохешей" видит для заявок со статусом "Утверждена" кнопку "Добавить геохеши". Создается серия транзакций по добавлению геохешей в Упаковку. Упаковка и Геохеши принадлежат PlotManager.

10. Создается транзакция, которая передает токен Участка обратно пользователю. Статус заявки меняется на "Уточнение произведено".

11. Валидаторы могут забрать свои награды из статуса "Уточнение произведено" и изменить статус Заявки `Получено вознаграждение валидатора`.

12. Адрес получателя комиссии может забрать свою комиссию и изменить статус на Закрыта.

13. Данный вид заявок не имеет функции отклонение.

14. Валидатор может вернуть заявку на доработку аналогично заявке на создание нового участка. 

15. Пользователь в меню действий по заявке может нажать кнопку `Вернуть участок`. Эта кнопка отображается для заявок со статусом Новая, Возвращена, Ожидание оплаты. При ее нажатии создается транзакция, которая возвращает токен Участка пользователю и меняет статус на "Разобрана заявителем". Так же пользователь может создать транзакцию и вернуть оплаченную комиссию из этих статусов.

16. Для валидатора для заявок со статусом Уточнение произведено, Отклонена, Разобрана заявителем отображается кнопка Получить вознаграждение.
