# Функционал SplitMerge - требования

## Описание проблемы
- Разделение и объединение земель;

## Цели контракта
- У пользователя должна быть возможность объединять и разделять свои земли;

## Сценарий контракта
### Сценарий 1: Разделение земель
Пользователь А вводные:

| Адрес пользователя | Земли (Space) | Репутация |
| ---------- | --------------- | ------- |
| 0x477...b65 | sezu01 | 500 |

1. Пользователь А хочет разделить sezu01. 
2. Вызывается метод splitSpace контракта Controller с аргументом sezu01.
3. Controller вызывает метод Split контракта Land с аргументом sezu01. 
4. Split возвращает массив из 32 дочерних элементов (sezu010, sezu011, sezu012 и т.д.) основываясь на родительском ( sezu01 ).
5. Controller разделяет репутацию родительского геохэша на 32 части используя метод splitReputation контракта репутации при этом начисляя 1/32 репутации на каждый переданный геохэш. 
6. Выполняется трансфер родительского геохэша от Пользователя А на адрес мультисига. 
7. В цикле проверяется, созданы ли дочерние геохэши и если нет, то происходит mint Space токена с заданным ID в виде дочернего геохэша и трансфер токена Пользователю А:

Пользователь А после выполнения сплита:

| Адрес пользователя | Земли (Space) | Репутация |
| ---------- | --------------- | ------- |
| 0x477...b65 | sezu010 | 15,625 |
| 0x477...b65 | sezu011 | 15,625 |
| 0x477...b65 | sezu012 | 15,625 |
| 0x477...b65 | sezu013 | 15,625 |
| 0x477...b65 | sezu014 | 15,625 |
| 0x477...b65 | sezu015 | 15,625 |
| 0x477...b65 | Остальные Space токены | 406,25 |

### Сценарий 2: Объединение земель
Пользователь Б вводные:

| Адрес пользователя | Земли (Space) | Репутация |
| ---------- | --------------- | ------- |
| 0x112...fc1 | sezu0b0 | 15,625 |
| 0x112...fc1 | sezu0b1 | 15,625 |
| 0x112...fc1 | sezu0b2 | 15,625 |
| 0x112...fc1 | sezu0b3 | 15,625 |
| 0x112...fc1 | sezu0b4 | 15,625 |
| 0x112...fc1 | sezu0b5 | 15,625 |
| 0x112...fc1 | Остальные Space токены | 406,25 |

1. Пользователь Б хочет объединить свои участки.
2. Пользователь вызывает метод mergeSpaces контракта Controller передавая список геохэшей для объединения в виде строки с разделителем.
3. Строка участков преобразуется в массив. Для каждого дочернего элемента, принадлежащему выбранному для объединения родителю выполняется трансфер на multisig.
4. Репутация из дочерних участков объединяется и передается родительскому участку.
5. Выполняется трансфер родительского участка ( sezu0b ) с multisig на адрес Пользователя Б.

Пользователь Б после выполнения мержа:

| Адрес пользователя | Земли (Space) | Репутация |
| ---------- | --------------- | ------- |
| 0x112...fc1 | sezu0b | 500 |


### Сценарий: Создание уникальных участков
1. Владелец  SPACE токенов может вызвать метод контракта SplitMerge и создать уникальный токен SPACE с уникальным идентификатором, например ghskkdsd73883nncjsgs6644. Владелец SPACE - токена ghskkdsd73883nncjsgs6644 контракт SplitMerge.

2. Владелец  SPACE токенов может вызвать метод контракта SplitMerge и добавить к созданному уникальному токену ghskkdsd73883nncjsgs6644 маппинг <id уникального токена> - <id стандартного токена с геохешем>.
Например, у пользователя есть 2 токена: [w24qg86](http://explorer.galtproject.io/map/#w24qg86) и [w24qg87](http://explorer.galtproject.io/map/#w24qg87). Он вызывает метод и записывает маппинг:

|id уникального участка|id геохеша|
|------------------|------------|
|ghskkdsd73883nncjsgs6644|[w24qg86](http://explorer.galtproject.io/map/#w24qg86)|
|ghskkdsd73883nncjsgs6644|[w24qg87](http://explorer.galtproject.io/map/#w24qg87)|

Пользователь записал маппинг.

3. Теперь пользователь может вызвать метод MergeCustomPlot контракта SplitMerge и указать в качестве аргумента ghskkdsd73883nncjsgs6644. 

3.1.1 Контракт SplitMerge проверяет, что ghskkdsd73883nncjsgs6644 принадлежит ему.

3.1.2. Контракт SplitMerge выполняет переводит токен ghskkdsd73883nncjsgs6644 пользователю, а токены [w24qg86](http://explorer.galtproject.io/map/#w24qg86) и [w24qg87](http://explorer.galtproject.io/map/#w24qg87) переводит себе.

3.1.3. Контракт SplitMerge переносит Залоги с w24qg87 и w24qg86 на ghskkdsd73883nncjsgs6644.

## Спецификация контракта

## Детальный Сценарий пользователя и описание интерфейса

## Особенности реализации на Solidity

## Особенности реализации на TypeScript
Сейчас главный геохэш - это sezu, который является примерно 1/4 частью всего Бир Тавила. Он делится на 32 участка, каждый из которых в последствии делится еще на 32. В итоге выпущенных участков 1024.

## Неоднозначные вопросы и ответы на них
Нужно сделать возможность упаковки большого количества токенов SPACE с id в виде геохешей в произвольный SPACE токен с отдельным видом id. Таким образом мы рещим проблемы с участками неправильной формы. Мы просто апроксимируем участок геохешами, создаем токен произвольного участки и прописываем маппинг нового произвольного участки и 10-30 геохешей. Дальше все операции по обьединение и разделению этого произвольного участка происходят с учетом записанного маппинга. Разделение и обьединение происходит так же через контракт SplitMerge.

