# Функционал SplitMerge - требования

## Описание проблемы
Необходимо обеспечить механизм обьединения и разделения участков. Необходимо обеспечить механизм создания Земельных участков произвольной формы.

## Цели контракта
- У пользователя должна быть возможность объединять и разделять Земельные участки, как в пределах одного разряда Геохеша, так и создавая Земельные участки произвольной формы.

## Сценарий контракта
### Сценарий 1: Разделение Земельного участка
Пользователь А вводные:

| Адрес пользователя | Токен SPACE | Репутация |
| ---------- | --------------- | ------- |
| 0x477...b65 | [sezu01](http://explorer.galtproject.io/map/#sezu01) | 500 |

1. Пользователь А хочет разделить [sezu01](http://explorer.galtproject.io/map/#sezu01).
2. Пользователь А вызывает метод AproveforToken() контракта Reputation, указывая аргументом токен sezu01, разрешая контракту SplitMerge распоряжаться `Репутацией` токена sezu01 в полном обьеме. Пользователь А вызывает метод Aprove() контракта SpaceToken и дает право контракту SplitMerge переводить токен sezu01.
3. Вызывается метод splitSpace контракта SplitMerge с аргументом `sezu01`.
4. SplitMerge вызывает метод Split контракта Land с аргументом `sezu01`. 
5. Split возвращает массив из 32 дочерних элементов sezu010, sezu011, sezu012 и т.д. основываясь на родительском sezu01.
6. Контракт SplitMerge проверяет по каждому элементу массива сущестовование SPACE токена. Если токена нет, то Контракт SplitMerge вызывает метод mint() контракт SpaceToken и создает соответствующие токены SPACE, владелец токенов - Контракт SplitMerge.
7. SplitMerge разделяет `Репутацию` токена SPACE [sezu01](http://explorer.galtproject.io/map/#sezu01) на 32 части используя метод transferFromToken() контракта Reputation и начисляет на 32 созданных токена SPACE. Одновременно токен sezu01 забирает себе SplitMerge, а 32 токена SPACE SplitMerge передает Пользователю А. 

Пользователь А после выполнения разделения Земельного участка:

| Адрес пользователя | Токен SPACE | Репутация |
| ---------- | --------------- | ------- |
| 0x477...b65 | sezu010 | 15,625 |
| 0x477...b65 | sezu011 | 15,625 |
| 0x477...b65 | sezu012 | 15,625 |
| 0x477...b65 | sezu013 | 15,625 |
| 0x477...b65 | sezu014 | 15,625 |
| 0x477...b65 | sezu015 | 15,625 |
| 0x477...b65 | Остальные Space токены | 406,25 |

### Сценарий 2: Объединение Земельного участки
Пользователь Б вводные:

| Адрес пользователя | Земли (Space) | Репутация |
| ---------- | --------------- | ------- |
| 0x112...fc1 | sezu0b0 | 15,625 |
| 0x112...fc1 | sezu0b1 | 15,625 |
| 0x112...fc1 | sezu0b2 | 15,625 |
| 0x112...fc1 | sezu0b3 | 15,625 |
| 0x112...fc1 | sezu0b4 | 15,625 |
| 0x112...fc1 | sezu0b5 | 15,625 |
| 0x112...fc1 | Остальные Space токены | 406,25 |

1. Пользователь Б хочет объединить свои участки sezu0b0, sezu0b1, sezu0b2 итд.
2. Пользователь Б вызывает метод AproveforToken() контракта Reputation, указывая аргументом массив токенов, которые он хочет объединить, разрешая контракту SplitMerge распоряжаться `Репутацией` этих токенов в полном обьеме. Пользователь А вызывает метод Aprove() контракта SpaceToken и дает право контракту SplitMerge переводить токены sezu0b0, sezu0b1, sezu0b2 итд.
3. Пользователь Б вызывает метод mergeSpaces контракта SplitMerge передавая список id SPACE токенов для объединения в виде строки с разделителем.
4. SplitMerge вызывает метод Merge() контракта Land. В качестве аргументов указываются id SPACE токенов, которые он хочет обьединить. Метод Merge() в случае успеха возвращает геохеш родителя этих 32 участков. В нашем случае sezu0b.
5. Контракт SplitMerge проверяет, что возвращенный геохеш родительского участка имеет токен SPACE и принадлежит SplitMerge. Если его не существует, то Контракт SplitMerge вызывает mint() контракта SpaceToken и создает токен, владелец SplitMerge.
6. SplitMerge суммирует Репутацию 32 токенов sezu0b0, sezu0b1, sezu0b2 итд. и переносит ее при помощи метода transferFromToken() контракта Reputation на токен sezu0b. И одновременно SplitMerge передает токен sezu0b Пользователю Б. А токены sezu0b0, sezu0b1, sezu0b2 итд. контракт SplitMerge забирает себе.

Пользователь Б после выполнения обьединения:

| Адрес пользователя | Земли (Space) | Репутация |
| ---------- | --------------- | ------- |
| 0x112...fc1 | sezu0b | 500 |


### Сценарий 3: Создание уникальных участков
1. Владелец  SPACE токенов может вызвать метод контракта SplitMerge CreateCustomPlot() и создать уникальный токен SPACE с уникальным идентификатором. Пользователь в качестве аргументов метода указывает геохеши точек границ уникального Земельного участка. Земельный участок имеет форму многоугольника. Каждая точка имеет разрядность 10-11 символов и является вершиной многоугольника. Например, были переданы следующие координаты треугольного участка: [w24qgy48e](http://explorer.galtproject.io/map/#w24qgy48e), [w24qgsqw3](http://explorer.galtproject.io/map/#w24qgsqw3),[w24qgumbk](http://explorer.galtproject.io/map/#w24qgumbk). Идентификатор SPACE токена уникального участка 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk. SPACE  Владелец SPACE - токена 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk контракт SplitMerge.

В контракте SplitMerge добавляется запись в маппинг CustomPlotBorders, который содержит соответствие `id уникального участка` - `координата вершины`. Эти координаты вершин носят справочный характер.

|Токен|номер позиции|координата вершины|
|-----|--------| --------|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|1|[w24qgy48e](http://explorer.galtproject.io/map/#w24qgy48e) |
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|2|[w24qgsqw3](http://explorer.galtproject.io/map/#w24qgsqw3) |
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|3|[w24qgumbk](http://explorer.galtproject.io/map/#w24qgumbk) |

Пусть у пользователя есть 3 токена: [w24qgv4](http://explorer.galtproject.io/map/#w24qgv4) и [w24qguf](http://explorer.galtproject.io/map/#w24qguf), [w24qguc](http://explorer.galtproject.io/map/#w24qguc).

|Токен|Владелец|
|-----|--------|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|Контракт SplitMerge |
|[w24qgv4](http://explorer.galtproject.io/map/#w24qgv4)|Пользователь |
|[w24qguf](http://explorer.galtproject.io/map/#w24qguf)|Пользователь |
|[w24qguc](http://explorer.galtproject.io/map/#w24qguc)|Пользователь |

2. Владелец  SPACE токенов может вызвать метод контракта SplitMerge  MergeCustomPlot() указать в качестве аргументов 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk и w24qguf. Можно указывать только один SPACE - токен, который нужно добавить в уникальный участок.

Метод  создает к уникальному токену 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk маппинг <id уникального токена> - <id стандартного токена с геохешем>.

|id уникального участка|номер позиции|id геохеша|
|------------------|------------|----------|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|1|[w24qguf](http://explorer.galtproject.io/map/#w24qguf)|

Контракт записал маппинг.

Контракт SplitMerge переводит токен 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk пользователю, а токен  и [w24qguf](http://explorer.galtproject.io/map/#w24qguf) переводит себе.

|Токен|Владелец|
|-----|--------|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|Пользователь|
|[w24qguf](http://explorer.galtproject.io/map/#w24qguf)|Контракт SplitMerge|

Контракт SplitMerge переносит Залог с [w24qguf](http://explorer.galtproject.io/map/#w24qguf) на 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk и происходит перераспределение `Репутации`.

3. У пользователя есть токен [w24qguc](http://explorer.galtproject.io/map/#w24qguc) и он тоже хочет его добавить в маппинг и включить в 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk. Он вызывает метод AddToCustomPlot(), указывает в нем 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk и w24qguc, а так же соседний участок, который был внесен ранее - w24qguf.

Контракт проверяет, что 743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk принадлежит пользователю. Контракт проверяет, что w24qguc принадлежит пользователю и его нет в маппинге. Контракт проверяет, что w24qguf принадлежит SplitMerge, является соседним участком с w24qguc и есть в маппинге `i743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk - <id стандартного токена с геохешем>`.

Контракт добавляет в маппинг [w24qguc](http://explorer.galtproject.io/map/#w24qguc).

Маппинг меняет вид на:

|id уникального участка|номер позиции|id геохеша|
|------------------|------------|-------|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|1|[w24qguf](http://explorer.galtproject.io/map/#w24qguf)|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|2|[w24qguc](http://explorer.galtproject.io/map/#w24qguc)|

Контракт забирает токен w24qg88 себе и становится его владельцем.

|Токен|Владелец|
|-----|--------|
|w24qg88|Контракт SplitMerge|

Контракт перераспределяет Залоги и Репутации.

4. Аналогично добавляется токен [w24qgv4](http://explorer.galtproject.io/map/#w24qgv4).

Маппинг меняет вид на:

|id уникального участка|номер позиции|id геохеша|
|------------------|------------|-------|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|1|[w24qguf](http://explorer.galtproject.io/map/#w24qguf)|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|2|[w24qguc](http://explorer.galtproject.io/map/#w24qguc)|
|743883bs7GEOw24qgy48hgdhhqgddqw663w24qgumbk|3|[w24qgv4](http://explorer.galtproject.io/map/#w24qgv4)|

![464cfe7bfb](https://user-images.githubusercontent.com/29427584/43321818-55f77654-91ad-11e8-939b-ba1dc391a287.jpg)


### Сценарий 4: Разбиение уникальных участков


## Спецификация контракта

## Детальный Сценарий пользователя и описание интерфейса

## Особенности реализации на Solidity

## Особенности реализации на TypeScript
Сейчас главный геохэш - это sezu, который является примерно 1/4 частью всего Бир Тавила. Он делится на 32 участка, каждый из которых в последствии делится еще на 32. В итоге выпущенных участков 1024.

## Неоднозначные вопросы и ответы на них
Нужно сделать возможность упаковки большого количества токенов SPACE с id в виде геохешей в произвольный SPACE токен с отдельным видом id. Таким образом мы рещим проблемы с участками неправильной формы. Мы просто апроксимируем участок геохешами, создаем токен произвольного участки и прописываем маппинг нового произвольного участки и 10-30 геохешей. Дальше все операции по обьединение и разделению этого произвольного участка происходят с учетом записанного маппинга. Разделение и обьединение происходит так же через контракт SplitMerge.

