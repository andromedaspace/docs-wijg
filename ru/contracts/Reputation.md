# Reputation
Контракт репутации

## Разделы

* [Описание проблемы](#Описание-проблемы)
* [Цели контракта](#Цели-контракта)
* [Примеры](#Примеры)
* [Спецификация](#Спецификация)
* [Технические аспекты](#Технические-аспекты)

## Описание проблемы
Мы используем кол-во GALT заложенных за Space токенов в качестве показателя, который определяет вес голоса
 при голосовании за делегатов фонда.

Залог от одного участка может быть распределен, как Репутация для одного или нескольких пользователей следующим образом:
* полное или частичное владение участком;
* полная или частичная аренда участка;

Динамический рассчет этого параметра в каждом вызове приведет к большому потреблению газа и мы достаточно быстро не сможем вписаться в один блок на mainnet.

## Цели контракта
Для решения этой проблемы, мы кешируем кол-во GALT, заложенных за Space токены и называем этот показатель `Репутация`.

## Примеры
### Пример 1. Пользователь единолично владеет участком и распределяет репутацию между фондами.
1. Пользователь А покупает Space токен `sezu0456` с репутацией 1000 GALT, выбрав фонд 3 для первоначального размещения всей репутации. Пользователь А владеет 100% репутации Space токена.

| | A |
| ---- | ---- |
| Фонд 0 | 0 |
| Фонд 1 | 0 |
| Фонд 2 | 0 |
| Фонд 3 | 1000 |

2. Пользователь А с помощью метода `distributeStakeReputation` перераспределяет свои 1000 GALT репутации между тремя фондами.

| | A |
| ---- | ---- |
| Фонд 0 | 200 |
| Фонд 1 | 500 |
| Фонд 2 | 0 |
| Фонд 3 | 300 |

### Пример 2. Пользователь единолично владеет участком, сдавая часть репутации в аренду двум другим пользователям.

1. Пользователь А покупает Space токен sezu0456 с репутацией 1000 GALT, выбрав фонд 3 для первоначального размещения всей репутации. Пользователь А владеет 100% репутации Space токена.

| | A | B | C |
| ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 0 |
| Фонд 1 | 0 | 0 | 0 |
| Фонд 2 | 0 | 0 | 0 |
| Фонд 3 | 1000 | 0 | 0 |

2. Пользователь А получает от пользователей В и C плату офф-чейн за то, что он распределит им на какое-то время соответсвтенно 250 и 300 GALT из репутации своего токена. Пользователи B и C доверяют пользователю А и понимают, что он в праве в любой момент отозвать у них репутацию без какой либо компенсации.

3. Пользователь А c помощью метода `getPreferredFund` узнает, что пользователь B предопочитет, чтобы назначаемая ему
репутация сразу была распределена в фонд 2, а пользователь С не указал своих пожеланий по этому поводу.

4. Пользователь А с помощью метода `changeTokenHolderStake` назначает пользователю B 250 GALT репутации фонд 2. 

| | A | B | C |
| ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 0 |
| Фонд 1 | 0 | 0 | 0 |
| Фонд 2 | 0 | 250 | 0 |
| Фонд 3 | 750 | 0 | 0 |

5. Пользователь А с помощью метода `changeTokenHolderStake` назначает пользователю C 300 GALT репутации фонд 0. 

| | A | B | C |
| ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 300 |
| Фонд 1 | 0 | 0 | 0 |
| Фонд 2 | 0 | 250 | 0 |
| Фонд 3 | 450 | 0 | 0 |

6. Пользоватей А и С устраивает распределение их репутации по фондам, а пользователя B нет. Он решает перенести 100 GALT репутации в фонд 3 и 50 в фонд 1, т.к. считает, что эти фонды смогут лучше использовать его заложенные средства. Для этого он использует метод `distributeStakeReputation`.

| | A | B | C |
| ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 300 |
| Фонд 1 | 0 | 50 | 0 |
| Фонд 2 | 0 | 100 | 0 |
| Фонд 3 | 450 | 100 | 0 |

### Пример 3. Токен передан на контракт совместной аренды.

1. Space токен sezu0456 имеет репутацию 1000 GALT и пренадлежит контракту совместной аренды А.
2. 200 GALT репутации этого токена распределено арендатору B, остаток контракт А распределил своему владельцу D.

| | A | B | C | D
| ---- | ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 0 | 0 |
| Фонд 1 | 0 | 200 | 0 | 0 |
| Фонд 2 | 0 | 0 | 0 | 0 |
| Фонд 3 | 0 | 0 | 0 | 800 |

3. В новом периоде аренды пользователь B внес лишь 170 репутации. Контракт аренды должен забрать у пользователя B 30 GALT репутации и назначить их арендатору C. В контракте не реализована сложная логика по рассчетам, в какой фонд сколько репутации было распределно пользователем В. Он может лишь отозвать сразу всю репутацию, а потом назначить ее заново.
4. Контракт вызывает метод отзыва revokeTokenHolderStake() и вся репутация в размере 200 GALT от пользователя B возвращается владельцу токена.

| | A | B | C | D
| ---- | ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 0 | 0 |
| Фонд 1 | 0 | 0 | 0 | 0 |
| Фонд 2 | 0 | 0 | 0 | 0 |
| Фонд 3 | 0 | 0 | 0 | 1000 |

5. Контракт токена вызывает метод changeTokenHolderStake() и назначает репутацию учатнику B в размере 170 Galt в фонд, который участник B установил по умолчанию (фонд 3).

| | A | B | C | D
| ---- | ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 0 | 0 |
| Фонд 1 | 0 | 0 | 0 | 0 |
| Фонд 2 | 0 | 170 | 0 | 0 |
| Фонд 3 | 0 | 0 | 0 | 830 |

6. Контракт вызывает метод назначения changeTokenHolderStake() и назначает репутацию учатнику С в размере 30 Galt в фонд, который участник С установил по умолчанию (фонд 1).

| | A | B | C | D
| ---- | ---- | ---- | ---- | ---- |
| Фонд 0 | 0 | 0 | 0 | 0 |
| Фонд 1 | 0 | 0 | 30 | 0 |
| Фонд 2 | 0 | 170 | 0 | 0 |
| Фонд 3 | 0 | 0 | 0 | 800 |

### Пример 4. Частичное переназначение репутации с помощью прямого переноса репутации между фондами (Владельцем токена является централизованный офф-чейн скрипт с приватным ключем):

1. Space токен sezu0456 имеет репутацию 1000 GALT и пренадлежит скрипту А. 200 GALT репутации этого токена распределено пользователю B, остаток у скрипта А. Пользователь B в свою очередь распределил свою репутацию следующим образом:

| | А (скрипт) | B | C |
| ---- | ---- | ---- | ---- |
| Фонд 0 | 800 | 40 | 0 |
| Фонд 1 | 0 | 30 | 0 |
| Фонд 2 | 0 | 130 | 0 |
| Фонд 4 | 0 | 0 | 0 |

2. Скрипт токена хочет забрать у пользователя B 30 GALT репутации и назначить их пользователю C. Информация о том, в какие фонды пользователь В распределил свои средства находится в блокчейне. Скрипт токена читает ее вызовом соответствующего метода.
3. Скрипт токена на свое усмотрение выбирает фонд 0 для списания репутации у пользователя В и вызывает метод changeTokenHolderStake с параметрами:
	- пользователь для списания: B
	- пользователь для зачисления: C
	- фонд для списания: 0
	- фонд для зачисления: 4
	- сумма: 30 GALT

| | А (скрипт) | B | C |
| ---- | ---- | ---- | ---- |
| Фонд 0 | 800 | 10 | 0 |
| Фонд 1 | 0 | 30 | 0 |
| Фонд 2 | 0 | 130 | 0 |
| Фонд 4 | 0 | 0 | 30 |

В этому случае скрипт может сэкономить на газе и на действиях, но обязан более детально просчитать свои действия.

## Спецификация
Репутация измеряется в GALT токенах.

Мы предоставляем владельцу токена методы на перераспределение его (токена) репутации. Дергать методы перераспределения могут:
- пользователь через специально написанный dApp + metamask (за определенный товар или услугу владелец Space токена назначает другому пользователю половину репутации своего токена на две недели), но здесь никто не гарантирует, что владелец не отзовет у тебя репутацию через день
- офф-чейн скрипт с приватным ключем
- контракт с любой логикой (мы предоставляем 2 дефолтных), контракт своим кодом должен гарантировать, что репутация не будет отозвана за определенный период
- сайдчейн (например, когда у токена должно быть 10000 участников, на mainnet все вычисления производить дорого и бессмысленно, проще и дешевле произвести их в своей сети, а в mainnet-е перераспределить лишь репутацию необходимым образом)

### Терминология
* Владелец Space токена - пользователь, которому принадлежит Space токен. Имеет безусловные права перераспределять репутацию токена между любым количеством адресов. Может иметь токен, но не иметь за него репутации, перераспределив 100% репутации другим адресам.
* Участник доли - адрес, которому владелец Space токена распределил определенную долю. Участник может в свою очередь распределять полученную долю по фондам (максимум 7 фондов за долю в конкретном токене).

### Константы
* 7 - максимальное кол-во фондов, в которые участник доли может распределить свою репутацию.

### Уровни кеширования репутации
Для упрощения доступа других контрактов к данным о репутации, кеш разделен на несколько уровней детализации от L1 - самый общий до L4 - самый детальный.

#### L1
* Сколько репутации имеет конкретный адрес за все токены во всех фондах.
* Сколько репутации имеет конкретный фонд за все токена ото всех участников долей.

#### L2
* Сколько репутации имеет конкретный адрес в конкретном фонде.

#### L3
* Сколько репутации конкретного токена имеет конкретный участник доли.
* Сколько репутации конкретного токена распределено в конкретный фонд.

#### L4
* Сколько репутации конкретного токена распределено конкретным участником доли в конкретный фонд.

### Интерфейс взаимодействия с контрактом
#### Mint - Выпуск репутации под Space токен
Право на выпуск репутации принадлежит контракту SpaceToken.
Репутация выпускается вместе с выпуском Space токена и назначается сразу владельцу токена/в фонд, указанный при подаче заявки на аукцион.

#### Increase - Увеличение репутации Space токена
Право на изменение принадлежит только владельцу Space токена.
Владелец Space токена может увеличить репутацию этого токена, пополнив ее на любую сумму от 1 GALT и указав фонд и адрес, на которые она будет распределена.

#### Fine - Списание репутации Space токена.
Право на списание репутации Space токена принадлежит только контракту реестра штрафов. 

#### ChangeTokenHolderStake - Изменение распределения репутации Space токена между участниками доли и фондами.
Право на изменение долей репутации Space токена принадлежит его владельцу.
Владалец Space токена имеет безусловные права перераспределять репутацию между участниками доли / фондами.

#### RevokeTokenHolderStake - Отзыв всей репутации конкретного участника доли.
Право на отзыв принадлежит владельцу Space токена.
Владелец Space токена может одной транзакцией в свою пользу отозвать репутацию изо всех фондов конкретного участника доли.
Информация о фондах, в которые участник доли распределит свои средства хранится в блокчейне.

#### DistributeStakeReputation - Изменение распределения репутации участника доли между фондами.
Право на изменения долей принадлежит участнику доли.
Участник доли может перераспределить свою репутацию между любыми фондами (макс. до 7 фондов).

#### PreferredFund - Установить и получить фонд по умолчанию.
Любой адрес может установить фонд, куда он хотел бы, чтобы переводилась репутация по умолчанию. Эту информацию могут использовать собственники Space токенов при принятии решений, к какому фонду привязывать начисляемую репутацию.

#### Кеш репутации по уровням L1, L2, L3, L4
Информация публичная.

Любой адрес может получить информацию о репутации по всем уровням.

### Прочее
* При смене владельца Space токена репутация не меняется. Новому владельцу необходимо самостоятельно перераспределить репутацию в соотвествии со своими пожеланиями.

## Технические аспекты
### TypeScript
* В боте остается 2 вида репутации - локальная и глобальная. Пределываение на одну глобальную займет времени, но ни на логику ни на интерфейс положительно не повлияет.

## Вопросы
* Может ли пользователь добровольно уменьшить репутацию своего токена и [получить обратно/сжечь] часть репутации?
* Определить минимальное кол-во GALT для перераспределения.
* Как изменяется репутация при split/merge?