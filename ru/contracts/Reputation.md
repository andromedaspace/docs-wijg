# Global Reputation
Контракт репутации

## Разделы

* [Описание проблемы](#Описание-проблемы)
* [Цели контракта](#Цели-контракта)
* [Примеры](#Примеры)
* [Спецификация](#Спецификация)
* [Технические аспекты](#Технические-аспекты)

## Описание проблемы
Мы используем кол-во GALT заложенных за Space токенов в качестве показателя, который определяет вес голоса
 при голосовании за делегатов фонда.
Динамический рассчет этого параметра в каждом вызове приведет к большому потреблению газа и мы достаточно быстро не сможем вписаться в один блок на mainnet.

## Цели контракта
Для решения этой проблемы, мы кешируем кол-во GALT, заложенных за Space токены и называем этот показатель `Репутация`.

## Примеры
### Пример 1А. Частичное переназначение репутации с помощью полного отзыва:

1. Space токен sezu0456 имеет репутацию 1000 GALT и пренадлежит пользователю А
2. 200 GALT репутации этого токена распределено пользователю B, остаток у пользователя А
3. Владелец токена хочет забрать у пользователя B 30 GALT репутации и назначить их пользователю C. Владалец не хочет утруждать себя рассчетами, в какой фонд сколько репутации было распределно пользователем В. Он решает отозвать сразу всю репутацию, а потом назначить ее заново.
4. Владелец вызывает метод отзыва revokeTokenHolderStake() и вся репутация в размере 200 GALT от пользователя B возвращается владельцу токена.
5. Владалец токена вызывает метод changeTokenHolderStake() и назначает репутацию учатнику B в размере 170 Galt в фонд, который участник B установил по умолчанию.
6. Владалец вызывает метод назначения changeTokenHolderStake() и назначает репутацию учатнику С в размере 30 Galt в фонд, который участник С установил по умолчанию.

### Пример 1В. Частичное переназначение репутации с помощью прямого переноса репутации между фондами:

1. Space токен sezu0456 имеет репутацию 1000 GALT и пренадлежит пользователю А
2. 200 GALT репутации этого токена распределено пользователю B, остаток у пользователя А
3. Пользователь B в свою очередь распределил свою репутацию следующим образом
	- 40 GALT в фонд 0
	- 30 GALT в фонд 1
	- 130 GALT в фонд 2
4. Владелец токена хочет забрать у пользователя B 30 GALT репутации и назначить их пользователю C. Информация о том, в какие фонды пользователь В распределил свои средства находится в блокчейне. Владелец токена читает ее вызовом соответствующего метода.
5. Владелец токена на свое усмотрение выбирает фонд 0 для списания репутации у пользователя В и вызывает метод changeTokenHolderStake с параметрами:
	- пользователь для списания: B
	- пользователь для зачисления: C
	- фонд для списания: 0
	- фонд для зачисления: 4
	- сумма: 30 GALT

<тут будет табличка, описывающая изменения>

В этому случае владелец может сэкономить на газе и на действиях, но обязан более детально просчитать свои действия.

### Пример 2. Перераспределение репутации участником доли между фондами.
1. Пользователь А покупает Space токен sezu0456 с репутацией 1000 GALT, выбрав фонд 3 для первоначального размещения всей репутации. Вся репутация токена принадлежит пользователю A.
2. Пользователь А получает от пользователя В плату офф-чейн за то, что он распределит пользователю В на какое-то время 300 GALT из репутации своего токена.
3. Пользователь А вызвает метод changeTokenHolderStake и назначает 300 GALT репутации пользователю В, явно указывая, что назначить ее необходимо в фонд 4.
А - 700
В - 300

4. Пользователь Б решает распределить свои 300 GALT репутации следующим образом:
- фонд 1 - 100
- фонд 2 - 150
- фонд 3 - 50

Для этого, он с помощью метода #distributeStakeReputation() за 3 транзакции переводит репутацию из фонда 4 в соответствующие фонды.

## Спецификация
Репутация измеряется в GALT токенах.

Мы предоставляем владельцу токена методы на перераспределение его (токена) репутации. Дергать методы перераспределения могут:
- пользователь через специально написанный dApp + metamask (за определенный товар или услугу владелец Space токена назначает другому пользователю половину репутации своего токена на две недели), но здесь никто не гарантирует, что владелец не отзовет у тебя репутацию через день
- офф-чейн скрипт с приватным ключем
- контракт с любой логикой (мы предоставляем 2 дефолтных), контракт своим кодом должен гарантировать, что репутация не будет отозвана за определенный период
- сайдчейн (например, когда у токена должно быть 10000 участников, на mainnet все вычисления производить дорого и бессмысленно, проще и дешевле произвести их в своей сети, а в mainnet-е перераспределить лишь репутацию необходимым образом)

### Терминология
* Владелец Space токена - пользователь, которому принадлежит Space токен. Имеет безусловные права перераспределять репутацию токена между любым количеством адресов. Может иметь токен, но не иметь за него репутации, перераспределив 100% репутации другим адресам.
* Участник доли - адрес, которому владелец Space токена распределил определенную долю. Участник может в свою очередь распределять полученную долю по фондам (максимум 7 фондов за долю в конкретном токене).

### Константы
* 7 - максимальное кол-во фондов, в которые участник доли может распределить свою репутацию.

### Уровни кеширования репутации
Для упрощения доступа других контрактов к данным о репутации, кеш разделен на несколько уровней детализации от L1 - самый общий до L4 - самый детальный.

#### L1
* Сколько репутации имеет конкретный адрес за все токены во всех фондах.
* Сколько репутации имеет конкретный фонд за все токена ото всех участников долей.

#### L2
* Сколько репутации имеет конкретный адрес в конкретном фонде.

#### L3
* Сколько репутации конкретного токена имеет конкретный участник доли.
* Сколько репутации конкретного токена распределено в конкретный фонд.

#### L4
* Сколько репутации конкретного токена распределено конкретным участником доли в конкретный фонд.

### Интерфейс взаимодействия с контрактом
#### Mint - Выпуск репутации под Space токен
Право на выпуск репутации принадлежит контракту SpaceToken.
Репутация выпускается вместе с выпуском Space токена и назначается сразу владельцу токена/в фонд, указанный при подаче заявки на аукцион.

#### Increase - Увеличение репутации Space токена
Право на изменение принадлежит только владельцу Space токена.
Владелец Space токена может увеличить репутацию этого токена, пополнив ее на любую сумму от 1 GALT и указав фонд и адрес, на которые она будет распределена.

#### Fine - Списание репутации Space токена.
Право на списание репутации Space токена принадлежит только контракту реестра штрафов. 

#### ChangeTokenHolderStake - Изменение распределения репутации Space токена между участниками доли и фондами.
Право на изменение долей репутации Space токена принадлежит его владельцу.
Владалец Space токена имеет безусловные права перераспределять репутацию между участниками доли / фондами.

#### RevokeTokenHolderStake - Отзыв всей репутации конкретного участника доли.
Право на отзыв принадлежит владельцу Space токена.
Владелец Space токена может одной транзакцией в свою пользу отозвать репутацию изо всех фондов конкретного участника доли.
Информация о фондах, в которые участник доли распределит свои средства хранится в блокчейне.

#### DistributeStakeReputation - Изменение распределения репутации участника доли между фондами.
Право на изменения долей принадлежит участнику доли.
Участник доли может перераспределить свою репутацию между любыми фондами (макс. до 7 фондов).

#### PreferredFund - Установить и получить фонд по умолчанию.
Любой адрес может установить фонд, куда он хотел бы, чтобы переводилась репутация по умолчанию. Эту информацию могут использовать собственники Space токенов при принятии решений, к какому фонду привязывать начисляемую репутацию.

#### Кеш репутации по уровням L1, L2, L3, L4
Информация публичная.

Любой адрес может получить информацию о репутации по всем уровням.

### Прочее
* При смене владельца Space токена репутация не меняется. Новому владельцу необходимо самостоятельно перераспределить репутацию в соотвествии со своими пожеланиями.

## Технические аспекты
### TypeScript
* В боте остается 2 вида репутации - локальная и глобальная. Пределываение на одну глобальную займет времени, но ни на логику ни на интерфейс положительно не повлияет.

## Вопросы
* Может ли пользователь добровольно уменьшить репутацию своего токена и [получить обратно/сжечь] часть репутации?
* Определить минимальное кол-во GALT для перераспределения.
* Как изменяется репутация при split/merge?