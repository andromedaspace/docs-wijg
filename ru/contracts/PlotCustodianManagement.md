# Контракт PlotCustodianManagement

## Описание проблемы
Нужно создать ликвидный производный инструмент для крипто-инвесторов, обеспеченные земельными активами.  Сделать так, чтобы передавать токен можно было без изменений права собственности на землю в государственном реестре, но при этом права владельцев токенов были защищены. Сделать так, чтобы под землю можно было выпустить ERC20 токен.

## Цели контракта
- Регистрация Кастодиана по земельному участку за комиссию.

## Ограничение
* Максимальное кол-во привязанных к SPACE токену кастодианов - 10 шт.

## Роли заявки
Роли заявки жестко прописаны в контракте PlotValuation. Список ролей в контракте Validators должен четко ему соответствовать

* `PC_CUSTODIAN_ROLE` - Кастодиан (n <= 10)
* `PC_AUDITOR_ROLE` - Аудитор (1)

# Содержание заявки

* ID токена упаковки
* Адрес выбранного пользователем кастодиана
* Действие:
  * ATTACH - привязать кастодиана
  * DETACH - отвязать кастодиана

# Действия заявки
## ATTACH
К участку можно привязать одного или несколько (до 10 шт.) кастодианов.

## DETACH
От участка можно отвязать несколько или всех сразу кастодианов.

# Распределение вознаграждения
* Galt Space - фиксированный процент, заданный владельцем контракта
* Аудито - фиксированный процент, заданный владельцем контракта
* Кастодианы - фиксированный процент распределяется между всеми учавствующими кастодианами равными долями

# Статусы
## Статусы заявок

* `SUBMITTED` - новая заявка, сразу после создания готова для блокировки указанным в ней кастодианом
* `REVERTED` - кастодиан не принял заявку в работу
* `LOCKED` - кастодиан готов работать над заявкой
* `REVIEW` - кастодиан работает над заявкой (переведен токен от заявителя)
* `APPROVED` - одобрена
* `COMPLETED` - выполнена (токен переведен обратно заявителю)
* `REJECTED` - не одобрена
* `CLOSED` - закрыта без модификации статуса кастодиана (токен переведен обратно заявителю)

# Статусы кастодианов
* `ACCEPTED` - кастодиан из списка изменяемых отметил, что
* `LOCKED` - уже существующий кастодиан или кастодиан из списка
* `APPROVED` - уже существующий кастодиан или кастодиан из списка
* `REJECTED` - уже существующий кастодиан или кастодиан из списка

# Статусы ролей (только для аудитора)

* `LOCKED` - аудитор заблокировал сделку
* `APPROVED` - аудитор одобрил сделку
* `REJECTED` - аудитор не одобрил сделку

![Application Status List](../../images/PlotCustodianManager.png?raw=true "Application Status List")

# Интерфейс для владельца контракта
Владелец контракта может:

* Изменить минимальный размер комиссии в ETH
* Изменить минимальный размер комиссии в GALT
* Изменить долю комиссии, распределяемой в пользу GaltSpace в ETH (остаток распределяется в пользу валидаторов)
* Изменить долю комиссии, распределяемой в пользу GaltSpace в GALT (остаток распределяется в пользу валидаторов)
* Установить, какой из способов оплаты сейчас принимается (никакой, GALT, ETH, GALT И ETH)
* Установить адрес выплат комиссий от огранизации GaltSpace
* Остановить/Возобновить работу контракта (напр. в случае подозрения на наличие уязвимости)

#### #resetApplicationRole()
Владелец контракта может снять конкретного валидатора с роли в заявке
* Метод возможен только для заявок в статусе LOCKED

#### #claimGaltSpaceReward()
Владелец контракта забирает свою долю комиссии, оплаченную заявителем
* Метод возможен только для заявок в статусе COMPLETED либо CLOSED
* В зависимости от выбранной валюты, на адрес, указанный владельцем контракта, перечисляются либо ETH либо GALT

## Интерфейс для заявителя

#### #submit()
Заявитель подает заявку на регистрацию токена упаковки у кастодиана
* Указывается список адресв кастодианов-валидаторов, к которым необходимо привязать SPACE токен
* Выполняется порверка, что все указанные адреса в действительности имеют назначенную роль PC_CUSTODIAN
* Указывается id SPACE токена
* Указывается действие - привязать или отвязать список
* Оплачивается комиссия в ETH или GALT
* В зависимости от поступившей оплаты, рассчитываются вознаграждения уже существующих валидаторов, аудитоар и Galt Space
* В случае добавления кастодианов создается 2 списка:
    * список добавляемых кастодианов
    * список текущих кастодианов
* В случае удаления кастодианов создается 2 списка:
    * список удаляемых кастодианов
    * список оставшихся кастодианов (текущие - удаляемые)
* Назначается статус заявки SUBMITTED

#### #resubmit()
Заявитель повторно подает заявку, возможно, с измененными данными
* Статус заявки должен быть REVERTED
* Статус заявки меняется на SUBMITTED

#### #attachToken()
Заявитель переводит токен упаковки на контракт
* Статус заявки должен быть LOCKED
* Происходит проверка, что именно этот токен был ранее указан в заявке
* Статус заявки меняется на REVIEW

#### #withdrawToken()
Заявитель выводит токен с контракта
* Статус заявки должен быть APPROVED
* Статус заявки меняется на COMPLETED

#### #close()
Заявитель закрывает незавершенную заявку либо заявку в статусе отказа

* Статус заявки должен быть LOCKED или REJECTED
* Если статус заявки REJECTED, то токен упаковки переходит обратно к заявителю
* Статус заявки меняется не CLOSED

## Интерфейс для кастодианов
#### #accept()
Кастодианы из списка на `добавление` подтверждают свое согласие на работу над заявкой

* Статус заявки должен быть SUBMITTED
* Статус кастодиана устанавливается в LOCKED
* Статус заявки меняется на LOCKED, если все кастодианы (из списка и текущие) изменняемых перевели свой статус в LOCKED

#### #revert()
Кастодиан (как из новых предложенных, так и из сущетсвующих) не соглашается на предложенные изменения над заявкой

* Статус заявки должен быть SUBMITTED
* Статус заявки меняется на REVERTED

#### #attachDocuments()
Любой из кастодианов устанавливает массив хешей IPFS документов

* Статус заявки должен быть REVIEW
* Статус заявки не меняется
* Все голосовавшие кастодианы сбрасываются в LOCKED
* Если проголосовал аудитор, его статус сбрасывается в LOCKED
* Каждый вызов метода перезаписывает массив документов, прикрепленный к заявке

## Интерфейс для аудитора
#### #lockAuditor()
Аудитор блокирует за собой работу над заявкой

* Статус заявки должен быть REVIEW
* Статус заявки не меняется
* Статус роли меняется на LOCKED

## Общий интерфейс для кастодианов и аудиторов
#### #rejectApplication()
Любой из кастодианов или аудитор не одобряет заявку

* Статус заявки должен быть REVIEW
* Статус заявки меняется на REJECTED

#### #approve()
Кастодиан одобряет изменение

* Статус заявки должен быть REVIEW
* Все участники (аудитор, кастодианы и заявитель)должны вызвать этот метод
* В зависимости от типа действия, кастодиан(ы) либо привязывается либо отвязывается от токена.
* Статус заявки меняется на APPROVED

#### #claimValidatorReward()
Валидатор забирает свое вознаграждение

* Статус заявки должен быть COMPLETED либо CLOSED
* В зависимости от типа заявки, на адрес валидатора перечисляются либо ETH либо GALT
* Поставляется флаг, что валидатор на данной роли получил вознаграждение
* Доля роли PC_CUSTODIAN распределяется равными частями между всеми учавствующими кастодианами
* Статус заявки не изменяется

## Сценарий UI 1: Регистрация токена земельного участка у Кастодиана
1. Если оценка земельного участка выполнена, то возможна регистрация земельного участка у Кастодиана. Регистрация предполагает переход права собственности на участок к Кастодиану с обязательством вернуть это право держателю SPACE токена.
2. В меню земельного участка доступна кнопку "Зарегистрировать участок у Кастодиана".
3. Появляются поля для ввода данных.

|Параметр|Значение по умолчанию|Тип|
|--------|--------|---------|
|ID Участка|Берется по выбранному участку, не редактируется|uint256|
|Селектор оплаты комиссии|GALT, меняется на ETH|Селектор|
|Поле для ввода комиссии|Минимальное значение комиссии|float|
|Рекомендуемая комиссия|Рассчитанная рекомендуемая комиссия|float|
|Кастодиан|Пусто, при нажатии отображается список допустимых Кастодианов с их отображанием на карте с описанием|Адрес|

4. Пользователь нажимает "Подтвердить" и создается транзакция с вызовом метода по созданию заявки.

5. Кастодиан в меню "Мои заявки на регистрацию прав" видит все заявки, которые были назначены ему. Он нажимает кнопку "Принять заявку". Заявка меняет статус на принята. Если Кастодиан нажимает отклонить заявку, то он возвращается Пользователю и пользователь может выбрать другого Кастодиана. Кастодиан должен указать причину отклонения заявки.

6. Пользователь, если заявка принята Кастодианом нажимает кнопку - "Отправить токен на контракт Регистрации". Создается транзакция, статус заявки меняется. Создается новый контракт, на который передется токен участка. Для вывода токена участка с контракта необходимо 3 подписи: Пользователя, Кастодиана и Аудитора. Оплачивается комиссия.

7. Кастодиан офчейн готовит все необходимые документы. Пользователь встречается с Кастодианом, подписывает все необходимые документы. Кастодиан выполняет регистрационные действия и после того, как они выполнены нажимает в меню заявки кнопку "Загрузить документы". Кастодиан загружает документы и подписывает транзакцию с сохранением документов в IPFS, а хеша в заявки и в контракте, на котором находится токен Участка.

8. После этого Пользователь, Кастодиан и Аудитор должны выполнить транзакцию, которая изменит статус заявки и передаст токен участка с контракта обратно пользователю. При этом Адрес Кастодиана будет зафиксирован в контракте.

## Сценарий UI 2: Отправка токена участка на DEX
1. После этого пользователь может отправить токен на DEX и получить токены GALT, которые были определены последней оценкой.

## Риски
* Даже при условии, что есть проблемы с присвоением кастодиана, все должны согласиться и присвоить его. По другому токен упаковки с контракта не вывести.
