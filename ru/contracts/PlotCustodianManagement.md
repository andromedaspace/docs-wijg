# Контракт PlotCustodianManagement

## Описание проблемы
Нужно создать ликвидный производный инструмент для крипто-инвесторов, обеспеченные земельными активами.  Сделать так, чтобы передавать токен можно было без изменений права собственности на землю в государственном реестре, но при этом права владельцев токенов были защищены. Сделать так, чтобы под землю можно было выпустить ERC20 токен.

## Цели контракта
- Регистрация Кастодиана по земельному участку за комиссию.

## Роли заявки
Роли заявки жестко прописаны в контракте PlotValuation. Список ролей в контракте Validators должен четко ему соответствовать

* `PC_CUSTODIAN_ROLE` - Кастодиан
* `PC_AUDITOR_ROLE` - Аудитор

# Содержание заявки

* ID токена упаковки
* Адрес выбранного пользователем кастодиана
* Действие:
  * ATTACH - привязать кастодиана
  * DETACH - отвязать кастодиана

# Статусы заявок

* `SUBMITTED` - новая заявка, сразу после создания готова для блокировки указанным в ней кастодианом
* `REVERTED` - кастодиан не принял заявку в работу
* `LOCKED` - кастодиан готов работать над заявкой
* `REVIEW` - кастодиан работает над заявкой (переведен токен от заявителя)
* `APPROVED` - одобрена
* `COMPLETED` - выполнена (токен переведен обратно заявителю)
* `REJECTED` - не одобрена
* `CLOSED` - закрыта без модификации статуса кастодиана (токен переведен обратно заявителю)

![Application Status List](../../images/PlotCustodianManager.png?raw=true "Application Status List")

# Интерфейс для владельца контракта
Владелец контракта может:

* Изменить минимальный размер комиссии в ETH
* Изменить минимальный размер комиссии в GALT
* Изменить долю комиссии, распределяемой в пользу GaltSpace в ETH (остаток распределяется в пользу валидаторов)
* Изменить долю комиссии, распределяемой в пользу GaltSpace в GALT (остаток распределяется в пользу валидаторов)
* Установить, какой из способов оплаты сейчас принимается (никакой, GALT, ETH, GALT И ETH)
* Установить адрес выплат комиссий от огранизации GaltSpace
* Остановить/Возобновить работу контракта (напр. в случае подозрения на наличие уязвимости)

#### #resetApplicationRole()
Владелец контракта может снять конкретного валидатора с роли в заявке
* Метод возможен только для заявок в статусе LOCKED

#### #claimGaltSpaceReward()
Владелец контракта забирает свою долю комиссии, оплаченную заявителем
* Метод возможен только для заявок в статусе COMPLETED либо CLOSED
* В зависимости от выбранной валюты, на адрес, указанный владельцем контракта, перечисляются либо ETH либо GALT

## Интерфейс для заявителя

#### #submitApplication()
Заявитель подает заявку на регистрацию токена упаковки у кастодиана
* Указывается конкретный адрес кастодиана-валидатора, которому будет подана заявка
* Указывается id токена упаковки
* Указывается действие - привязать или отвязать кастодиана
* Оплачивается комиссия в ETH или GALT
* Назначается статус заявки SUBMITTED

#### #resubmitApplication()
Заявитель повторно подает заявку, возможно, с измененными данными
* Статус заявки должен быть REVERTED
* Статус заявки меняется на SUBMITTED

#### #attachToken()
Заявитель переводит токен упаковки на контракт
* Статус заявки должен быть LOCKED
* Происходит проверка, что именно этот токен был ранее указан в заявке
* Статус заявки меняется на REVIEW

#### #withdrawToken()
Заявитель выводит токен с контракта
* Статус заявки должен быть APPROVED
* Статус заявки меняется на COMPLETED

#### #closeApplication()
Заявитель закрывает незавершенную заявку либо заявку в статусе отказа

* Статус заявки должен быть LOCKED или REJECTED
* Если статус заявки REJECTED, то токен упаковки переходит обратно к заявителю
* Статус заявки меняется не CLOSED

## Интерфейс для валидаторов
#### #acceptApplication()
Кастодиан соглашается работать над заявкой

* Статус заявки должен быть SUBMITTED
* Статус заявки меняется на LOCKED, если роль аудитора уже имеет статус LOCKED

#### #lockApplication()
Аудитор блокирует работу над заявкой

* Статус заявки должен быть SUBMITTED
* Статус роли валиадтора меняется на LOCKED
* Статус заявки меняется на LOCKED, если роль кастодиана уже имеет статус LOCKED

#### #revertApplication()
Кастодиан не соглашается работать над заявкой
* Статус заявки должен быть SUBMITTED
* Статус заявки меняется на REVERTED

#### #attachDocuments()
Кастодиан прилагает массив хешей IPFS документов
* Статус заявки должен быть REVIEW
* Статус заявки не меняется
* Каждый вызов метода перезаписывает массив документов, прикрепленный к заявке

#### #approveApplication()
Кастодиан, заявитель и аудитор одобряет заявку.

* Статус заявки должен быть REVIEW
* Все 3 стороны должны вызвать этот метод
* В зависимости от типа действия, кастодиан либо привязывается либо отвязывается от токена.
* Статус заявки меняется на APPROVED

#### #rejectApplication()
Кастодиан и аудитор не одобряют заявку

* Статус заявки должен быть REVIEW
* Статус заявки меняется на REJECTED


#### #claimValidatorReward()
Валидатор забирает свое вознаграждение

* Статус заявки должен быть COMPLETED либо CLOSED
* В зависимости от типа заявки, на адрес валидатора перечисляются либо ETH либо GALT
* Поставляется флаг, что валидатор на данной роли получил вознаграждение
* Статус заявки не изменяется

## Сценарий UI 1: Регистрация токена земельного участка у Кастодиана
1. Если оценка земельного участка выполнена, то возможна регистрация земельного участка у Кастодиана. Регистрация предполагает переход права собственности на участок к Кастодиану с обязательством вернуть это право держателю SPACE токена.
2. В меню земельного участка доступна кнопку "Зарегистрировать участок у Кастодиана".
3. Появляются поля для ввода данных.

|Параметр|Значение по умолчанию|Тип|
|--------|--------|---------|
|ID Участка|Берется по выбранному участку, не редактируется|uint256|
|Селектор оплаты комиссии|GALT, меняется на ETH|Селектор|
|Поле для ввода комиссии|Минимальное значение комиссии|float|
|Рекомендуемая комиссия|Рассчитанная рекомендуемая комиссия|float|
|Кастодиан|Пусто, при нажатии отображается список допустимых Кастодианов с их отображанием на карте с описанием|Адрес|

4. Пользователь нажимает "Подтвердить" и создается транзакция с вызовом метода по созданию заявки.

5. Кастодиан в меню "Мои заявки на регистрацию прав" видит все заявки, которые были назначены ему. Он нажимает кнопку "Принять заявку". Заявка меняет статус на принята. Если Кастодиан нажимает отклонить заявку, то он возвращается Пользователю и пользователь может выбрать другого Кастодиана. Кастодиан должен указать причину отклонения заявки.

6. Пользователь, если заявка принята Кастодианом нажимает кнопку - "Отправить токен на контракт Регистрации". Создается транзакция, статус заявки меняется. Создается новый контракт, на который передется токен участка. Для вывода токена участка с контракта необходимо 3 подписи: Пользователя, Кастодиана и Аудитора. Оплачивается комиссия.

7. Кастодиан офчейн готовит все необходимые документы. Пользователь встречается с Кастодианом, подписывает все необходимые документы. Кастодиан выполняет регистрационные действия и после того, как они выполнены нажимает в меню заявки кнопку "Загрузить документы". Кастодиан загружает документы и подписывает транзакцию с сохранением документов в IPFS, а хеша в заявки и в контракте, на котором находится токен Участка.

8. После этого Пользователь, Кастодиан и Аудитор должны выполнить транзакцию, которая изменит статус заявки и передаст токен участка с контракта обратно пользователю. При этом Адрес Кастодиана будет зафиксирован в контракте.

## Сценарий UI 2: Отправка токена участка на DEX
1. После этого пользователь может отправить токен на DEX и получить токены GALT, которые были определены последней оценкой.

## Риски
* Даже при условии, что есть проблемы с присвоением кастодиана, все должны согласиться и присвоить его. По другому токен упаковки с контракта не вывести.
