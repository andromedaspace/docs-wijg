# Функционал обратного выкупа Galt токена - Требования

## Описание проблемы
Каждый пользователь имеет право в любой момент вернуть свои ETH, которые он потратил на покупку Galt токена.

## Цели контракта
- Сделать функционал, который позволит пользователю обменивать Galt токены на ETH;

## Сценарий контракта
### Сценарий 1: Обратный выкуп
Вводные пользователя Б:

| Адрес пользователя | Баланс в Galt | Баланс в ETH |
| ---------- | --------- | --------- |
| 0xca2...88f | 30 000 | 10 |
| Остальные адреса | X | Y |

Фонды:

| Адрес фонда | Баланс в ETH | Баланс в GALT | Репутация |
| ---------- | --------- | --------- | --------- |
| 0xa0a...b2b | 100 | 200 000 | 125 000 |
| 0x7ca...90c | 400 | 800 000 | 375 000 |

Контракт адрес выкупа:

| Баланс в GALT |
| ---------- |
| 15 000 |

Выход из GALT выполняется раундами по X часов.
1. Начинается раунд 1.
2. Пользователь создает заявку на вывод GALT вызывая метод createProposal контракта GaltExit. В аргумент к методу
Пользователь Б передает кол-во GALT (5 000), которые он хочет обменять. В заявке фиксируется число репутации во всех фондах(500 000)
и общее количество выпущенных GALT(2 000 000).
3. Затем в течении раунда 1 Пользователь Б вызывает метод executeProposalForFund, передавая в аргумент адрес фонда.
В методе фиксируется кол-во репутации и ETH для фонда, адрес которого был передан в метод. Так же по мере транзакций
пользователя в методе фиксируется общее количество репутации и ETH для всех фондов, адреса которых были переданы в аргумент.
Этот метод необходимо вызывать для всех фондов!
4. После вызова метода executeProposalForFund для всех своих фондов Пользователь Б вызывает метод finishProposal.
В методе происходит проверка, отличается ли общее кол-во всех зафиксированных репутаций от общей репутации во всех фондах.
Если различия не более 1%, и если прошло не более суток с момента создания заявки, то пользователь может вызвать метод
closeProposal, переключая статус заявки на закрытую.
5. Пользователь вызывает метод getEthFromFund для каждого фонда, передавая в аргумент адрес фонда. Если раунд еще не закончен,
то у пользователя забирается часть GALT и перечисляется на адрес выкупа.
Количество GALT, за которые заплатит фонд высчитывается по формуле:

(РЕПУТАЦИЯ УКАЗАННОГО В АРГУМЕНТЕ ФОНДА / ЗАФИКСИРОВАННОЕ ЧИСЛО РЕПУТАЦИИ ВСЕХ ФОНДОВ) * КОЛИЧЕСТВО GALT ОТ КОТОРЫХ ОТКАЗЫВАЕТСЯ ПОЛЬЗОВАТЕЛЬ

| Адрес фонда | Баланс в ETH | Баланс в GALT | GALT за которые заплатит фонд |
| ---------- | --------- | --------- | -----------|
| 0xa0a...b2b | 100 | 200 000 | (125 000 / 500 000) * 5 000 = 0.25 * 5 000 = 1 250 |
| 0x7ca...90c | 400 | 800 000 | (375 000 / 500 000) * 5 000 = 0.75 * 5 000 = 3 750 |

6. Текущий курс GALT к ETH который определяется по формуле:

(ОБЩЕЕ КОЛ-ВО ВЫПУЩЕННЫХ GALT - БАЛАНС АДРЕСА ВЫКУПА) / ОБЩИЙ БАЛАНС ETH ВО ВСЕХ ФОНДАХ
(2 000 000 - 15 000) / 500 = 3 970

7. На основе курса GALT к ETH пользователю из каждого фонда выплачивается соответствующее количество ETH в обмен на GALT по формуле:

GALT ЗА КОТОРЫЕ ЗАПЛАТИТ ФОНД / КУРС GALT к ETH

| Адрес фонда | Баланс в ETH | Баланс в GALT | GALT за которые заплатит фонд | ETH которые получит пользователь |
| ---------- | --------- | --------- | -----------| -----------|
| 0xa0a...b2b | 100 | 200 000 | 1 250 | 1 250 / 3 970 = 0.315 |
| 0x7ca...90c | 400 | 800 000 | 3 750 | 3 750 / 3 970 = 0.945 |

Балансы пользователя Б на окончание 1-ого раунда:

| Адрес пользователя | Баланс в Galt | Баланс в ETH |
| ---------- | --------- | --------- |
| 0xca2...88f | 25 000 | 11.259 |
| Остальные адреса | X | Y |

Фонды:

| Адрес фонда | Баланс в ETH | Баланс в GALT |
| ---------- | --------- | --------- |
| 0xa0a...b2b | 99.685 | 200 000 |
| 0x7ca...90c | 266,67 | 800 000 |

Контракт адрес выкупа:

| Баланс в GALT |
| ---------- |
| 20 000 |

6. Раунд 1 окончен.

## Спецификация контракта
[Модель расчетов в Google Sheets](https://docs.google.com/spreadsheets/d/1zlbQGaYeIdah-t1EdBrl5jdTBGEeJ2JANazXgkxRzms/edit?usp=sharing)

## Детальный Сценарий пользователя и описание интерфейса

## Ограничения для реализации на Solidity

## Ограничения для реализации на TypeScript

## Неоднозначные вопросы и ответы на них
### В каком виде должны хранится GALT в контракте "адрес выкупа"?

### По какому курсу пользователи смогут купить GALT в контркте "адрес выкупа"?

### Сколько часов должен длиться один раунд?

### Какое различие можно допустить при сравнении общего кол-ва всех зафиксированных репутаций на момент вызова
finishProposal от общей репутации во всех фондах? 1% или больше?
