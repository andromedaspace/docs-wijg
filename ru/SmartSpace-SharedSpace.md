# SmartSpace - Совместная собственность
Контракт аренды Space токена SharedSpaceBasic.

Контракт не является частью инфраструктуры фондов.

## Разделы

* [Цели](#Цели)
* [Сценарий контракта.](#Сценарий-контракта)
* [Спецификация](#Спецификация)
* [Технические аспекты](#Технические-аспекты)
* [Проблемы](#Проблемы)

## Цели.

* Сделать так, чтобы залог в GALT и репутацию одного участка можно было разделить между большим количеством адресов (совместных владельцев) без разделения самого участка.
* Сделать так, чтобы участок можно было передать другому адресу только решением 100% его совместных владельцев.
* Сделать так, чтобы совместные владельцы имели такие же возможности, как единоличные владельцы земли.
* Сделать так, чтобы каждый владелец мог передать свой залог и свою репутацию другому адресу или сделать обратный выкуп у Фонда.

## Сценарий контракта.
### Сценарий 1.
1. Пользователь A имеет в собственности Space токен, залоговая стоимость которого составляет 2500 GALT.
    * 2500 репутации принадлежат пользователю А
2. Пользователь B создает контракт совместной собственности и просит друга (A) -владельца перечислить туда Space токен.
При создании контракта указывается следующие параметры:
    * 100% репутации за Space токен предлагаются на рынке за 5000 GALT
    * Владелец контракта получает 3000 GALT раночной стоимости (60%)

При этом никаких изменений в репутации. Работа с контрактом заблокирована - ожидается поступление Space токена

3. Пользователь A перечисляет свой Space токен на контракт.
    * Работа с контрактом активируется.
	* Пользователь А получает всю репутацию токена 2500
	* Другие участники могут приобрести репутацию не более 40% или 1000 GALT (`2500 - 3000/5000 * 2500 = 1000`)
	* Репутация опльзователя А не может стать меньше 1500 (при условии отсутсвтия наложенных на Space токен штрафов)

Пользователи | A | B |
--- | --- | --- |
Репутация до | 2500 | 0 |
Репутация после | 2500 | 0 |
Залог до | 0 | 0 |
Залог после | 0 | 0 |

4. Пользователь B вносит залог 1500 GALT
    * 750 репутации принадлежат пользователю
    * 1750 репутации принадлежат контрату

Пользователи | A | B |
--- | --- | --- |
Репутация до | 2500 | 0 |
Репутация после | 1750 | 750 |
Залог до | 0 | 0 |
Залог после | 0 | 1500 |
GALT на контракте до | 0 | 0 |
GALT на контракте после | 0 | 1500 |


5. Пользователь А выводит залог пользователя B на свой адрес

Пользователи | A | B |
--- | --- | --- |
Репутация до | 2500 | 0 |
Репутация после | 1750 | 750 |
Залог до | 0 | 0 |
Залог после | 0 | 1500 |
GALT на контракте до | 0 | 0 |
GALT на контракте после | 0 | 0 |

6. Пользователь С выполняет попытку внести 1000 GALT залога для получения 500 GALT репутации. Транзакция отменяется,
 т.к.:
    * 2500 - общая залоговая стоимость Space токена
    * 1500 - репутация владельца контракта не может опуститься ниже этого порога
    * 750 - репутация принадлежит пользователю B
    * 250 - репутация, доступная для покупки за 500 GALT

7. Пользователь A выполняет попытку перенести 500 GALT залога другому пользователю. Транзакция отменятеся, т.к.
 репутация пользователя А не может опустится ниже 60%

8. Пользователь B переводит 500 GALT залога (250 репутации) пользователю C.

Пользователи | A | B | D |
--- | --- | --- | --- |
Репутация до | 2500 | 750 | 0 |
Репутация после | 1750 | 500 | 250 |
Залог до | 0 | 1500 | 0 |
Залог после | 0 | 1000 | 500 |
GALT на контракте до | 0 | 0 | 0 |
GALT на контракте после | 0 | 0 | 0 |

9. Пользователь D вызывает функцию, согласно которой, фонд обязан выкупить репутацию любого пользователя кроме владельца
по цене, рассчитаной в соответствии с залоговой стоимостью токена.

Пользователи | A | B | D | Фонд |
--- | --- | --- | --- | --- |
Репутация до | 1750 | 500 | 250 | 0 |
Репутация после | 1750 | 500 | 0 | 250|
Залог до | 0 | 0 | 500 | 0 |
Залог после | 0 | 1000 | 0 | 500 |
GALT на контракте до | 0 | 0 | 0 | 0 |
GALT на контракте после | 0 | 0 | 0 | 0 |

Пользователь D получил 250 GALT и лишился всей своей репутации в рамках данного контракта.

10. Пользователи A, B и Фонд голосуют за вывод токена на адрес F.
    * Пользователь `A` голосует `за`
    * Пользователь `B` голосует `за`
    * Фонд голосует против
Транзакция по выводу токена не может выполнена.

11. Фонд меняет свой голос на `за`. Теперь можно вывести токен на адрес F. Выполнить транзакию возможно пока статус
всех голосов находится в состоянии `за`.

12. Пользователь B вызывает и оплачивает транзакцию вывода. Space токен переводится на адрес F

Пользователи | A | B | D | F | Фонд |
--- | --- | --- | --- | --- | --- |
Репутация до | 1750 | 500 | 0 | 0 |  250|
Репутация после | 0 | 0 | 0 | 2500 | 0 |
Залог до | 0 | 1000 | 0 | 0 | 500 |
Залог после | 0 | 0 | 0 | 0 |
GALT на контракте до | 0 | 0 | 0 | 0 | 0 |
GALT на контракте после | 0 | 0 | 0 | 0 | 0 |

## Спецификация
### Создание контракта
* Создать контракт совместной собственности должен пользователь, который в дальнейшем пречислит на него Space токен.
* При создаии контракта указываются следующие параметры:
    * Рыночная стоимость 100% репутации Space токена. Она может быть как меньше так и больше заложенного за токен депозита.
    * Рыночная стоимость процента репутации, которая будет принадлежать адресу владельца контракта.
* При попытке перевода второго токена на контракт транзакция отменяется.
* Созданный контракт является не активным, пока на него не будет передан один space токен.
* После перевода токена, 100% его репутации принадлежит контракту. По сути это будет не-активная репутация, но в кастомных реализация контрактов совместной собственности остается возможность использования этой репутации в любых целях. Это может быть 
    * Распределение 100% репутации между любыми адресами в любом соотношении.
    * Голосование за кого-либо на выборах.

### Вход участников
* Минимальный депозит задается в контракте и не может быть менее 1 GALT

### Изменение доли
* Пользователь может в любой момент как увеличить так и уменьшить свой депозит.
* Пользователь может в любой момент передать как часть так и весь
 свой депозит другому пользователю.
* Собственник контракта не может передать свою фиксированную долю, определенную при
создании контракта, другому пользователю.

### Штрафы Space токена
* В случае, если к Space токену применяются штарфные санкции, репутация списывается
у всех участников пропорционально депозиту.
* Рыночная стоимость контракта в случае штрафов не меняется.

### Голосование
* При голосовании учитывается размер депозита конкретного пользователя.
* Если пользователь уменьшает или увеличивает свою долю в тот момент, когда идут какие-либо голосования, в них так же перерасчитывается доля пользователя.

### Выход участников
* Любой участник может выйти и забрать свой депозит без согласия остальных.
* Фонд обязан в любой момент выкупить долю по залоговой стоимости пропорционально доле пользователя, выплатив ее эквивалет в GALT.

### Удаление контракта
* Вывести SpaceToken токен возможно лишь совместным голосованием, согласие всех участников должно быть 100%.
* При выводе токена:
    * репутация ото всех участников передается сначала на контракт
    * потом мы убеждаемся, что отозванная репутация равна репутации токена (мало ли у кого не забрали)
    * Только после этого вся репутация вместе с токеном переходит адресу, на который выводится токен

* Контракт без токена бесполезен - его можно удалить а можно и оставить.

### Прочее
* Залоги пользователей отношением адрес => залог в GALT (mapping(address => number))
* На каждое изменение пользовательского залога происходит соответствующее изменение в контрактах Loacal Reputation и Global Reputation
* Мы не можем хранить список пользователей владельцев участка, это потребует добавления цикла.
 Поэтому у нас не будет функционала отображения всех пользователей, которые учавствуют в контракте. (аналогичный функционал в ERC20 токене)
* Единственное голосование всех участников возможно по поводу вывода токена на другой адрес.
Поэтому список голосов держим в отдельном mapping-е, а адрес, куда выводить отдельной строкой.
    * Поменять адрес вывода токена может только собственник контракта.
    * При смене адреса вывода сбрасываются все голоса за и против.


## Технические аспекты
### Solidity
Подход реализации сброса голосования за вывод токена.
Чтобы сбросить голосование, инкрементируется currentVoting.
Старые значения остаются в блокчейне, но уже не будут считаться актуальными.

```solidity
pragma solidity ^0.4.24;

contract Test {
    mapping(uint => mapping(address => bool)) oks;
    uint needToReach = 1000;
    uint currentSum = 0;
    uint currentVoting = 0;

    function seed() {
        for (var i = 0; i < 100; i++) {
            var a = address(keccak256(i));
            oks[currentVoting][a] = true;
            currentSum += 10;
        }
    }

    function execute() {
        assert(needToReach == currentSum);
        // execute
    }

    function reset() {
        currentVoting = currentVoting + 1;
        currentSum = 0;
    }
}
```
# Проблемы
* Нужен ли whitelist адресов, с которых разрешено покупать?
* Может ли владелец GALT токена выступить в роли участника и докупить долю?
* Что делать с апатией голосования при большом кол-ве участников? Сейчас у нас требование 100% согласия участников
 на вывод токена
